<!DOCTYPE html>
<meta charset="utf-8">

<style>

path {
  stroke: #555;
  stroke-width: 1; 
}

#neighborhoodPopover { 
  position: absolute;     
  text-align: center;         
  padding: 2px;       
  font: 12px sans-serif;    
  background: #fff; 
  border: 0px;    
  border-radius: 8px;     
  pointer-events: none;
  opacity: 0;     
}

circle {
  stroke: black;
  fill: green;
  stroke-width: .1;
}
</style>

<body>
  <svg width="960" height="720"></svg>
  <div id='neighborhoodPopover'> </div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-geo@4"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>
<script src="node_modules/chroma-js/chroma.js"></script>
<script>

let locationsVisible = false;

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");


const startDate = '2024-09-01', endDate = '2024-09-25';

Promise.all([
  fetch(`/location-analytics?start_date=${startDate}&end_date=${endDate}`).then(response => response.json()),
  fetch(`/district-neighborhood-analytics?start_date=${startDate}&end_date=${endDate}&geometry_type=neighborhood`).then(response => response.json()),
  fetch(`/geojson-geometries?geometry_type=neighborhood`).then(response => response.json())
]).then(([locationsData, neighborhoodMap, nyc ]) => {
  console.log(locationsData, neighborhoodMap, nyc);

  const projection = 
          d3.geoConicConformal()
            .parallels([33, 45])
            .rotate([96, -39])
            .fitSize([width, height], nyc);

  var path = d3.geoPath()
      .projection(projection);


  const fillScale = chroma.scale(['#ADD8E6', '#FF474C'])

  svg.selectAll("path")
      .data(nyc.features)
      .enter().append("path")
      .attr("d", path)
      .attr("fill", feature => {
        const neighborhoodNameFromFeature = feature.properties.neighborhood;
        const metadata = neighborhoodMap[neighborhoodNameFromFeature];
        if(metadata != undefined){
            const opacity = metadata['percentage'];
            return fillScale(opacity);
        } else {
            console.log("Couldn't find this neighborhood", neighborhoodNameFromFeature);
            return 'white';
        }
      })
      .on("mouseenter", function(feature) {
        const neighborhoodNameFromFeature = feature.properties.neighborhood;
        const metadata = neighborhoodMap[neighborhoodNameFromFeature];
        if(metadata != undefined){
          d3.select(this)
          .style("stroke", 'yellow')
          .style("stroke-width", 1.5);

          d3.select("#neighborhoodPopover")
          .transition()
          .style("opacity", 1)
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY) + "px")
          .text(`${feature.properties.neighborhood} (${metadata['totalUsers']} total users)`)
        } else {
          d3.select("#neighborhoodPopover")
          .transition()
          .style("opacity", 1)
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY) + "px")
          .text(feature.properties.neighborhood)
        }
      })
      .on("mouseleave", function(d) {
        d3.select(this)
        .style("stroke", '#555')
        .style("stroke-width", 1);

        d3.select("#neighborhoodPopover")
        .transition()
        .style("opacity", 0);
      })
      .on('click', function(d){
        locationsVisible = !locationsVisible;
        svg.selectAll("circle")
          .each(function() {
              d3.select(this).style("visibility", locationsVisible ? "visible" : "hidden");
          });
      })
    ;

    console.log(nyc);


  svg.selectAll("circles.points")
      .data(Object.values(locationsData))
      .enter()
      .append("circle")
      .attr("r",1)
      .attr("transform", function(d) {return "translate(" + projection([d.longitude,d.latitude]) + ")";})
      .on("mouseenter", function(locationData) {
        // look up total users and organization name for a particular location
        // maybe click through to yourpeer/gogetta? 
        const totalUsersAnalyticsMetadata = locationsData[locationData.slug];
        if(totalUsersAnalyticsMetadata != undefined){
          d3.select(this)
          .style("fill", 'yellow');

          d3.select("#neighborhoodPopover")
          .transition()
          .style("opacity", 1)
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY) + "px")
          .text(`${locationData.organizationName} (${totalUsersAnalyticsMetadata.totalUsers} total users)`)
        }
      })
      .on("mouseleave", function(d) {
        d3.select(this)
          .style("fill", 'green');

        d3.select("#neighborhoodPopover")
        .transition()
        .style("opacity", 0);
      });

})

</script>
</body>


